<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANIBOOM WEB | Principal</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'Orbitron',sans-serif;}
body{background:#0b0b0b;color:#fff;overflow-x:hidden;}

/* HEADER */
header{position:fixed;top:0;width:100%;z-index:1000;display:flex;justify-content:space-between;align-items:center;padding:1rem 2rem;background:rgba(0,0,0,.45);backdrop-filter:blur(10px);}
header .logo{display:flex;align-items:center;gap:1rem;}
header .logo img{width:55px;height:55px;border-radius:50%;border:2px solid gold;}
header .logo span{font-family:'Press Start 2P';font-size:.9rem;color:#ffd700;text-shadow:0 0 6px gold,0 0 18px gold;}

/* CAMPANA */
.notification-btn{position:relative;cursor:pointer;display:flex;align-items:center;}
.notification-btn i{font-size:1.8rem;color:#ffd700;text-shadow:0 0 5px #ffd700,0 0 10px #ffd700,0 0 20px #ffd700,0 0 40px #ffd700;transition:all 0.3s;}
.notification-btn.shake i{animation:shake 0.5s infinite;}
.notification-btn .dot{position:absolute;top:-5px;right:-5px;width:14px;height:14px;background:red;border-radius:50%;border:2px solid #fff;display:none;z-index:10;}
@keyframes shake{0%,100%{transform:rotate(0deg);}25%{transform:rotate(15deg);}50%{transform:rotate(-15deg);}75%{transform:rotate(15deg);}}

/* MENÚ 3 PUNTOS */
.menu-btn{width:26px;display:flex;flex-direction:column;gap:5px;cursor:pointer;}
.menu-btn span{height:3px;background:gold;border-radius:3px;transition:.4s;}
.menu-btn.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px);}
.menu-btn.active span:nth-child(2){opacity:0;}
.menu-btn.active span:nth-child(3){transform:rotate(-45deg) translate(6px,-6px);}

.menu-popup{position:absolute;top:60px;right:0;background:#111;border:2px solid gold;border-radius:12px;padding:1rem;display:none;flex-direction:column;gap:1rem;box-shadow:0 0 15px gold;min-width:220px;z-index:2000;}
.profile-box{display:flex;flex-direction:column;align-items:center;background:#222;border:2px solid gold;border-radius:12px;padding:1rem;gap:0.5rem;width:100%;}
.profile-box img{width:60px;height:60px;border-radius:50%;border:2px solid gold;}
.profile-box p{color:gold;font-weight:700;text-align:center;}
.profile-box span{color:#ccc;font-size:0.8rem;text-align:center;}
.profile-box .btn-row{display:flex;gap:0.5rem;width:100%;justify-content:center;}
.profile-box .btn-row button{flex:1;padding:.5rem;font-weight:700;background:gold;color:#000;border:none;border-radius:12px;cursor:pointer;}
.menu-texts{display:flex;flex-direction:column;gap:0.3rem;text-align:center;margin-top:0.5rem;}
.menu-texts span{cursor:pointer;color:#ffd700;font-weight:700;text-decoration:underline;}

/* BOTONES Y UTILIDADES */
#sensibilidadesLink{display:none;}
#adminUtils{display:none;margin-top:0.5rem;}

/* MAIN */
main{padding:120px 2rem 3rem;}
.title{text-align:center;font-size:2.4rem;color:#ffd700;margin-bottom:.5rem;text-shadow:0 0 6px gold,0 0 20px gold;}
.desc{text-align:center;color:#aaa;margin-bottom:2rem;}

/* NOTIFICACIONES PANEL */
#notificationsPanel{position:fixed;top:0;right:-100%;width:100%;height:100%;background:#111;z-index:9999;transition:right .5s ease;overflow-y:auto;padding:2rem;}
#notificationsPanel.show{right:0;}
#notificationsPanel .closeBtn{position:absolute;top:10px;right:10px;font-size:1.5rem;color:#ff0000;cursor:pointer;}
.section{margin-bottom:2rem;}
.section h2{color:gold;font-size:1.5rem;margin-bottom:1rem;text-shadow:0 0 6px gold;}
.notification-card{background:#222;border:2px solid gold;border-radius:12px;padding:1rem;margin-bottom:1rem;position:relative;}
.notification-card h3{color:gold;margin-bottom:0.5rem;}
.notification-card p{color:#ccc;margin-bottom:0.5rem;}
.notification-card a{display:inline-block;padding:.5rem 1rem;background:gold;color:#000;text-decoration:none;border-radius:6px;font-weight:700;}
.notification-card button.removeBtn{position:absolute;top:5px;right:5px;background:red;color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px;}
.timer-circle{position:absolute;top:5px;left:5px;width:25px;height:25px;border:2px solid gold;border-radius:50%;font-size:0.6rem;display:flex;justify-content:center;align-items:center;color:gold;}

/* RESPONSIVE */
@media(max-width:768px){main{padding:150px 1rem 3rem;}.menu-popup{right:10px;top:60px;}}
</style>
</head>
<body>

<header>
  <div class="logo">
    <img src="logo.png" alt="Logo DaniBoom">
    <span>DANIBOOM WEB</span>
  </div>

  <div style="display:flex;align-items:center;gap:1rem;position:relative;">
    <!-- CAMPANA -->
    <div class="notification-btn" id="notificationBtn">
      <i class="fa fa-bell"></i>
      <div class="dot" id="notificationDot"></div>
    </div>

    <!-- 3 PUNTOS -->
    <div style="position:relative;">
      <div class="menu-btn" id="menuBtn"><span></span><span></span><span></span></div>
      <div class="menu-popup" id="menuPopup">
        <div class="profile-box">
          <img id="profilePic" src="default.png" alt="Perfil">
          <p id="profileName">Cargando...</p>
          <span id="profileRole">Cargando rol...</span>
          <div class="btn-row">
            <button id="viewProfile" onclick="window.location.href='rede.html'">Ver Perfil</button>
            <button id="logoutBtn">Cerrar Sesión</button>
          </div>
          <div id="adminUtils">
            <button onclick="window.location.href='notificaciones.html'">Gestionar Notificaciones</button>
          </div>
        </div>

        <!-- Textos fuera del cuadro -->
        <div class="menu-texts">
          <span id="redesLink" onclick="window.location.href='rede.html'">Redes</span>
          <span id="sensibilidadesLink" onclick="window.location.href='sensibilidades.html'">Sensibilidades</span>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <h1 class="title">Bienvenido a mi página</h1>
  <p class="desc">Soy tu rushero favorito de FREE FIRE. Disfruta todo lo que hay aquí: videos, actualizaciones, información de sistemas y mucho más.</p>
</main>

<div id="notificationsPanel">
  <div class="closeBtn" id="closeNotif">&times;</div>
  <div class="section" id="videosSection"><h2>Videos Nuevos</h2></div>
  <div class="section" id="systemSection"><h2>Sistema / Actualizaciones</h2></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, collection, onSnapshot, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// ===== CONFIG FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyChOQg743fsmGK89KVLoNAri_VGklArRi4",
  authDomain: "web1-3b83a.firebaseapp.com",
  projectId: "web1-3b83a",
  storageBucket: "web1-3b83a.appspot.com",
  messagingSenderId: "519590670968",
  appId: "1:519590670968:web:cb291125919a12e9e7b"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

// ELEMENTOS
const profilePic = document.getElementById('profilePic');
const profileName = document.getElementById('profileName');
const profileRole = document.getElementById('profileRole');
const logoutBtn = document.getElementById('logoutBtn');
const menuBtn = document.getElementById('menuBtn');
const menuPopup = document.getElementById('menuPopup');
const adminUtils = document.getElementById('adminUtils');
const sensibilidadesLink = document.getElementById('sensibilidadesLink');
const notificationBtn = document.getElementById('notificationBtn');
const notificationDot = document.getElementById('notificationDot');
const notificationsPanel = document.getElementById('notificationsPanel');
const closeNotif = document.getElementById('closeNotif');
const videosSection = document.getElementById('videosSection');
const systemSection = document.getElementById('systemSection');

// MENU 3 PUNTOS
menuBtn.addEventListener('click', ()=>{
  menuBtn.classList.toggle('active');
  menuPopup.style.display = (menuPopup.style.display==='flex')?'none':'flex';
  menuPopup.style.flexDirection='column';
});

// DETECCIÓN USUARIO Y ROLES
onAuthStateChanged(auth, async user=>{
  if(!user){
    // NO HAY USUARIO LOGUEADO → REDIRIGE A INDEX
    window.location.href="index.html";
    return;
  }

  // TRAE DATOS DE FIRESTORE
  const userRef = doc(db,"users",user.uid);
  const docSnap = await getDoc(userRef);
  if(docSnap.exists()){
    const data = docSnap.data();
    profileName.textContent = data.displayName || "Anónimo";
    profileRole.textContent = "Rol: "+(data.membership || "Invitado");
    profilePic.src = data.photoURL || "default.png";

    // CONTROL DE ROLES
    const membership = data.membership;
    if(membership==="anonymous" || membership==="Invitado"){
      logoutBtn.style.display="none";
      adminUtils.style.display="none";
      sensibilidadesLink.style.display="none";
    } else {
      logoutBtn.style.display="block";
      sensibilidadesLink.style.display="inline-block";
      if(membership==="admin" || membership==="owner"){
        adminUtils.style.display="block";
      } else {
        adminUtils.style.display="none";
      }
    }
  } else {
    // SI NO EXISTE EN FIRESTORE → REDIRIGE A INDEX
    window.location.href="index.html";
  }
});

// NOTIFICACIONES
const notificationsRef = collection(db,"notifications");
onSnapshot(notificationsRef,snapshot=>{
  videosSection.innerHTML="";
  systemSection.innerHTML="";
  let hasUnread=false;

  snapshot.docs.forEach(docSnap=>{
    const notif = docSnap.data();
    if(notif.deleted) return;
    const card = document.createElement("div");
    card.className="notification-card";
    card.innerHTML=`<h3>${notif.title}</h3><p>${notif.message}</p>`;
    if(notif.link) card.innerHTML+=`<a href="${notif.link}" target="_blank">Ir al video</a>`;
    const timer = document.createElement("div");
    timer.className="timer-circle";
    card.appendChild(timer);

    let start = notif.startTime||Date.now();
    let duration = notif.duration||30000;
    let end = start+duration;
    const interval = setInterval(()=>{
      let remaining = Math.max(Math.ceil((end-Date.now())/1000),0);
      timer.textContent=remaining;
      if(remaining<=0){ card.remove(); clearInterval(interval); }
    },1000);

    if(profileRole.textContent.includes("admin")||profileRole.textContent.includes("owner")){
      const removeBtn = document.createElement("button");
      removeBtn.className="removeBtn"; removeBtn.textContent="x";
      removeBtn.onclick=async()=>{ await updateDoc(doc(db,"notifications",docSnap.id),{deleted:true}); };
      card.appendChild(removeBtn);
    }

    if(notif.section==="videos") videosSection.appendChild(card);
    else systemSection.appendChild(card);

    hasUnread=true;
  });

  if(hasUnread){ notificationBtn.classList.add('shake'); notificationDot.style.display="block"; }
  else{ notificationBtn.classList.remove('shake'); notificationDot.style.display="none"; }
});

// CAMPANA
notificationBtn.addEventListener('click', ()=>{
  notificationsPanel.classList.toggle('show');
  notificationBtn.classList.remove('shake');
  notificationDot.style.display="none";
});

// CERRAR PANEL
closeNotif.addEventListener('click', ()=>{ notificationsPanel.classList.remove('show'); });

// LOGOUT
logoutBtn.addEventListener('click', async()=>{ await signOut(auth); window.location.href="index.html"; });
</script>
</body>
</html>