<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DANIBOOM | Neon Command v11.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-gold: #ffd700; --neon-blue: #00f2ff; --neon-red: #ff0000; --neon-green: #39ff14; --neon-orange: #ff8c00;
            --glass: rgba(255, 255, 255, 0.03); --blur: blur(25px);
            --shadow-gold: 0 0 15px #ffd700;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        body { background: #000; color: #fff; overflow-x: hidden; }

        /* --- EFECTOS DE ROL NEÓN --- */
        .effect-owner { color: var(--neon-red) !important; text-shadow: 0 0 20px var(--neon-red); animation: pulse-red 1.5s infinite alternate; }
        .effect-admin { color: var(--neon-orange) !important; text-shadow: 0 0 15px var(--neon-orange); }
        .effect-suscriptor { color: var(--neon-gold) !important; text-shadow: 0 0 15px var(--neon-gold); }
        @keyframes pulse-red { from { filter: brightness(1); } to { filter: brightness(1.5); } }

        header {
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.95); border-bottom: 2px solid var(--neon-gold); 
            backdrop-filter: var(--blur); position: sticky; top: 0; z-index: 2000; box-shadow: var(--shadow-gold);
        }

        /* MENÚ LATERAL */
        #sideNav {
            position: fixed; top: 0; left: -100%; width: 280px; height: 100vh;
            background: rgba(0,0,0,0.98); z-index: 4000; transition: 0.5s;
            padding: 40px 20px; border-right: 1px solid var(--neon-gold); backdrop-filter: blur(30px);
        }
        #sideNav.active { left: 0; }
        .nav-link { color: #fff; text-decoration: none; font-family: 'Orbitron'; display: block; margin-bottom: 25px; cursor: pointer; transition: 0.3s; }
        .nav-link:hover { color: var(--neon-gold); padding-left: 10px; }

        /* NOTIFICACIONES */
        .notif-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); backdrop-filter: blur(40px); z-index: 5000; display: none; flex-direction: column; padding: 20px; }
        .notif-full.active { display: flex; }

        .container { max-width: 1200px; margin: 20px auto; padding: 15px; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .glass-card { background: var(--glass); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 15px; padding: 20px; backdrop-filter: var(--blur); position: relative; }

        /* AVATAR Y LÁPIZ */
        .avatar-wrapper { position: relative; display: inline-block; }
        .p-avatar { width: 110px; height: 110px; border-radius: 50%; border: 3px solid transparent; transition: 0.5s; object-fit: cover; }
        .edit-pen { position: absolute; bottom: 5px; right: 5px; background: var(--neon-gold); color: #000; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: none; }

        /* MODALES */
        .full-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .full-modal.active { display: flex; }
        .modal-option { width: 80%; max-width: 300px; padding: 15px; margin: 10px; border: 1px solid var(--neon-gold); color: var(--neon-gold); background: transparent; border-radius: 10px; font-family: 'Orbitron'; text-align: center; cursor: pointer; }
        
        .role-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 18px; border-radius: 5px; border: 2px solid currentColor; font-family: 'Orbitron'; font-size: 0.75rem; text-transform: uppercase; }

        @media (max-width: 850px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <div onclick="toggleNav()" style="color:var(--neon-gold); cursor:pointer; font-size:1.5rem;"><i class="fas fa-bars"></i></div>
    <div style="font-family:'Orbitron'; color:var(--neon-gold); text-shadow: var(--shadow-gold);">DANIBOOM_OS</div>
    <div onclick="toggleNotifs()" style="color:var(--neon-gold); cursor:pointer; font-size:1.5rem;"><i class="fas fa-bell"></i></div>
</header>

<nav id="sideNav">
    <div onclick="toggleNav()" style="text-align:right; font-size:2rem; color:var(--neon-red); cursor:pointer;">&times;</div>
    <div style="margin-top:30px;">
        <a href="main.html" class="nav-link"><i class="fas fa-home" style="color:var(--neon-blue)"></i> INICIO</a>
        <div onclick="showSection('profile')" class="nav-link"><i class="fas fa-user" style="color:var(--neon-gold)"></i> MI PERFIL</div>
        <div onclick="showSection('missions')" class="nav-link"><i class="fas fa-bolt" style="color:var(--neon-gold)"></i> MISIONES</div>
        <div onclick="showSection('reports')" class="nav-link"><i class="fas fa-file-contract" style="color:var(--neon-blue)"></i> MIS REPORTES</div>
        <div onclick="showSection('blacklist')" class="nav-link"><i class="fas fa-user-slash" style="color:var(--neon-red)"></i> BLOQUEADOS</div>
        <div onclick="logout()" class="nav-link" style="color:var(--neon-red); margin-top:40px;"><i class="fas fa-power-off"></i> CERRAR SESIÓN</div>
    </div>
</nav>

<div class="notif-full" id="notifPanel">
    <div onclick="toggleNotifs()" style="position:absolute; top:20px; right:30px; font-size:3rem; color:var(--neon-red); cursor:pointer;">&times;</div>
    <h1 style="font-family:'Orbitron'; color:var(--neon-gold); text-align:center; margin-top:50px;">NOTIFICACIONES</h1>
    <div id="notifList" style="max-width: 600px; margin: 30px auto; width: 100%;"></div>
</div>

<div class="full-modal" id="modalAvatar">
    <div onclick="closeAvatarModal()" style="position:absolute; top:20px; right:30px; font-size:3rem; color:var(--neon-red); cursor:pointer;">&times;</div>
    <div id="avatarOptions" style="display: flex; flex-direction: column; align-items: center;">
        <h2 style="font-family:'Orbitron'; color:var(--neon-gold); margin-bottom:20px;">OPCIONES</h2>
        <div class="modal-option" onclick="showViewPhoto()">VER FOTO</div>
        <div class="modal-option" onclick="document.getElementById('fileInput').click()">CAMBIAR FOTO</div>
        <div class="modal-option" onclick="copyUserID()">COPIAR ID</div>
    </div>
    <div id="avatarView" style="display: none; flex-direction: column; align-items: center;">
        <img src="" id="full-avatar-img" style="width:280px; height:280px; border-radius:50%; border:4px solid var(--neon-gold); object-fit:cover;">
        <button class="modal-option" style="margin-top:30px;" onclick="resetModal()">VOLVER</button>
    </div>
    <div id="avatarPreview" style="display: none; flex-direction: column; align-items: center;">
        <img src="" id="imgPreviewField" style="width:250px; height:250px; border-radius:50%; object-fit:cover;">
        <button class="modal-option" onclick="uploadNewPhoto()">GUARDAR CAMBIOS</button>
        <button class="modal-option" style="color:var(--neon-red);" onclick="resetModal()">CANCELAR</button>
    </div>
</div>

<input type="file" id="fileInput" style="display: none;" accept="image/*">

<div class="container" id="appInterface" style="visibility: hidden;">
    <aside class="glass-card" style="text-align:center;">
        <div class="avatar-wrapper">
            <img src="default.png" id="p-avatar" class="p-avatar">
            <button class="edit-pen" onclick="openAvatarModal()"><i class="fas fa-pencil-alt"></i></button>
        </div>
        <h2 id="p-name" style="font-family:'Orbitron'; margin-top:15px;">PILOTO</h2>
        <div id="p-role-badge" class="role-badge"><i id="p-role-icon" class="fas"></i> <span id="p-role-text">---</span></div>
        <div id="lvl-display" style="color:var(--neon-blue); margin-top:15px; font-size:0.8rem;">LVL 01</div>
        <div style="width:100%; height:8px; background:#111; border-radius:4px; overflow:hidden; margin-top:5px;">
            <div id="xp-fill" style="height:100%; background:var(--neon-gold); width:0%; transition:1s;"></div>
        </div>
    </aside>

    <main>
        <section id="sec-profile" class="glass-card">
            <h3 id="welcome-msg" style="font-family:'Orbitron'; color:var(--neon-gold);">INFO NÚCLEO</h3>
            <p id="core-desc" style="color:#888; margin-top:10px;">Sincronizando datos...</p>
        </section>

        <section id="sec-reports" class="glass-card" style="display:none;">
            <h3>MIS REPORTES</h3><div id="reports-container"></div>
        </section>

        <section id="sec-blacklist" class="glass-card" style="display:none;">
            <h3 style="color:var(--neon-red)">BLOQUEADOS</h3><div id="blacklist-container"></div>
        </section>

        <section id="sec-missions" class="glass-card" style="display:none;">
            <h3 style="color:var(--neon-gold)">MISIONES DIARIAS</h3>
            <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-top:15px;">
                <strong>EXPLORACIÓN DE RED</strong><p>Gana +20 XP</p>
                <button onclick="handleMission(20)" id="btn-m1" style="background:var(--neon-gold); border:none; padding:5px 10px; margin-top:10px; cursor:pointer;">RECLAMAR</button>
            </div>
        </section>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyChOQg743fsmGK89KVLoNAri_VGklArRi4", authDomain: "web1-3b83a.firebaseapp.com", projectId: "web1-3b83a" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    let uData = {};
    let tempImg = "";

    onAuthStateChanged(auth, (user) => {
        if (user) {
            onSnapshot(doc(db, "users", user.uid), (snap) => {
                uData = snap.data() || {};
                const role = uData.membership ? uData.membership.toLowerCase() : null;
                if (!role) { location.href = "index.html"; }
                else {
                    document.getElementById('appInterface').style.visibility = 'visible';
                    renderUI(uData, role);
                }
            });
            listenNotifs(); // Activar notificaciones
        } else { location.href = "index.html"; }
    });

    function renderUI(data, role) {
        document.getElementById('p-name').innerText = (data.displayName || "PILOTO").toUpperCase();
        document.getElementById('p-avatar').src = data.photoURL || "default.png";
        document.getElementById('lvl-display').innerText = "LVL " + (data.level || 1);
        document.getElementById('xp-fill').style.width = (data.xp || 0) + "%";
        document.getElementById('p-role-text').innerText = role;

        const icon = document.getElementById('p-role-icon');
        const badge = document.getElementById('p-role-badge');
        badge.className = "role-badge effect-" + role;
        icon.className = "fas " + (role === 'owner' ? "fa-crown" : role === 'admin' ? "fa-shield-halved" : "fa-star");
    }

    // SISTEMA NOTIFICACIONES
    function listenNotifs() {
        const q = query(collection(db, "notifications"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('notifList');
            list.innerHTML = "";
            snap.forEach(d => {
                const n = d.data();
                list.innerHTML += `<div style="background:rgba(255,255,255,0.05); padding:15px; margin-bottom:10px; border-left:4px solid var(--neon-gold)">
                    <small style="color:var(--neon-blue)">${new Date(n.timestamp?.seconds*1000).toLocaleString()}</small>
                    <p style="margin-top:5px;">${n.message}</p>
                </div>`;
            });
        });
    }

    // FUNCIONES GLOBALES
    window.toggleNav = () => document.getElementById('sideNav').classList.toggle('active');
    window.toggleNotifs = () => document.getElementById('notifPanel').classList.toggle('active');
    window.showSection = (id) => {
        document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
        document.getElementById('sec-' + id).style.display = 'block';
        toggleNav();
    };
    window.logout = () => signOut(auth).then(() => location.href = "index.html");

    // LÓGICA AVATAR
    window.openAvatarModal = () => document.getElementById('modalAvatar').classList.add('active');
    window.closeAvatarModal = () => document.getElementById('modalAvatar').classList.remove('active');
    window.resetModal = () => {
        document.getElementById('avatarOptions').style.display = 'flex';
        document.getElementById('avatarView').style.display = 'none';
        document.getElementById('avatarPreview').style.display = 'none';
    };
    window.showViewPhoto = () => {
        document.getElementById('avatarOptions').style.display = 'none';
        document.getElementById('avatarView').style.display = 'flex';
        document.getElementById('full-avatar-img').src = uData.photoURL || "default.png";
    };
    document.getElementById('fileInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
            tempImg = ev.target.result;
            document.getElementById('avatarOptions').style.display = 'none';
            document.getElementById('avatarPreview').style.display = 'flex';
            document.getElementById('imgPreviewField').src = tempImg;
        };
        reader.readAsDataURL(file);
    });
    window.uploadNewPhoto = async () => {
        await updateDoc(doc(db, "users", auth.currentUser.uid), { photoURL: tempImg });
        alert("¡Foto Actualizada!");
        closeAvatarModal();
    };
    window.copyUserID = () => {
        navigator.clipboard.writeText(auth.currentUser.uid);
        alert("ID Copiado.");
    };

</script>
</body>
</html>
