<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DANIBOOM | Neon Command v11.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-gold: #ffd700; --neon-blue: #00f2ff; --neon-red: #ff0000; --neon-green: #39ff14; --neon-orange: #ff8c00;
            --glass: rgba(255, 255, 255, 0.03); --blur: blur(25px);
            --shadow-gold: 0 0 15px #ffd700;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        body { background: #000; color: #fff; overflow-x: hidden; }

        /* --- EFECTOS DE ROL NEÓN --- */
        .effect-dueno { color: var(--neon-red) !important; text-shadow: 0 0 15px var(--neon-red); animation: pulse-red 1.5s infinite alternate; }
        .effect-admin { color: var(--neon-orange) !important; text-shadow: 0 0 15px var(--neon-orange); }
        .effect-suscriptor { color: var(--neon-gold) !important; text-shadow: 0 0 15px var(--neon-gold); }

        @keyframes pulse-red { from { filter: brightness(1); } to { filter: brightness(1.5); } }

        header {
            padding: 15px 5%; display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.95); border-bottom: 2px solid var(--neon-gold); 
            backdrop-filter: var(--blur); position: sticky; top: 0; z-index: 2000; box-shadow: var(--shadow-gold);
        }

        .container { max-width: 1200px; margin: 20px auto; padding: 15px; display: grid; grid-template-columns: 320px 1fr; gap: 20px; }
        .glass-card { background: var(--glass); border: 1px solid rgba(255, 215, 0, 0.2); border-radius: 15px; padding: 20px; backdrop-filter: var(--blur); position: relative; }

        .role-badge { 
            display: inline-flex; align-items: center; gap: 8px; margin-top: 10px;
            padding: 5px 15px; border-radius: 5px; border: 1px solid currentColor;
            font-family: 'Orbitron'; font-size: 0.7rem; font-weight: bold; text-transform: uppercase;
        }

        .report-item, .block-item { 
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,215,0,0.1); 
            padding: 15px; border-radius: 12px; margin-bottom: 12px; 
            display: flex; align-items: center; gap: 15px; transition: 0.3s;
        }
        .report-icon { font-size: 1.5rem; filter: drop-shadow(0 0 5px currentColor); }
        .status-text { font-family: 'Orbitron'; font-size: 0.7rem; letter-spacing: 1px; }
        .date-text { font-size: 0.7rem; color: #666; display: block; margin-top: 5px; }

        .btn-neon {
            padding: 8px 15px; border-radius: 8px; border: 1px solid var(--neon-gold);
            background: transparent; color: var(--neon-gold); font-family: 'Orbitron'; font-size: 0.65rem;
            cursor: pointer; transition: 0.3s; text-shadow: var(--shadow-gold);
        }
        .btn-neon:hover { background: var(--neon-gold); color: #000; box-shadow: var(--shadow-gold); }
        .btn-red { border-color: var(--neon-red); color: var(--neon-red); text-shadow: 0 0 10px var(--neon-red); }

        .notif-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); backdrop-filter: blur(40px); z-index: 5000; display: none; flex-direction: column; padding: 20px; }
        .notif-full.active { display: flex; }

        @media (max-width: 850px) { .container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <div onclick="toggleNav()" style="color:var(--neon-gold); cursor:pointer; font-size:1.5rem;"><i class="fas fa-bars"></i></div>
    <div style="font-family:'Orbitron'; color:var(--neon-gold); text-shadow: var(--shadow-gold);">DANIBOOM_OS</div>
    <div id="bellBtn" onclick="toggleNotifs()" style="color:var(--neon-gold); cursor:pointer; font-size:1.5rem;"><i class="fas fa-bell"></i></div>
</header>

<div class="notif-full" id="notifPanel">
    <div onclick="toggleNotifs()" style="position:absolute; top:20px; right:30px; font-size:3rem; color:var(--neon-red); cursor:pointer;">&times;</div>
    <h1 style="font-family:'Orbitron'; color:var(--neon-gold); text-align:center; margin-top:50px; text-shadow: var(--shadow-gold);">NOTIFICACIONES</h1>
    <div id="notifList" style="max-width: 600px; margin: 30px auto; width: 100%;"></div>
</div>

<nav id="sideNav" style="position:fixed; top:0; left:-100%; width:280px; height:100vh; background:rgba(0,0,0,0.98); z-index:4000; transition:0.5s; padding:40px 20px; border-right:1px solid var(--neon-gold); backdrop-filter: blur(30px);">
    <div onclick="toggleNav()" style="text-align:right; font-size:2rem; color:var(--neon-red); cursor:pointer;">&times;</div>
    <div style="margin-top:30px; display:flex; flex-direction:column; gap:20px;">
        <a href="main.html" style="color:#fff; text-decoration:none; font-family:'Orbitron';"><i class="fas fa-home" style="color:var(--neon-blue)"></i> INICIO</a>
        <a href="#" onclick="showSection('profile')" style="color:#fff; text-decoration:none; font-family:'Orbitron';"><i class="fas fa-user" style="color:var(--neon-gold)"></i> ESTADO</a>
        <a href="#" onclick="showSection('missions')" style="color:#fff; text-decoration:none; font-family:'Orbitron';"><i class="fas fa-bolt" style="color:var(--neon-gold)"></i> MISIONES</a>
        <a href="#" onclick="showSection('reports')" style="color:#fff; text-decoration:none; font-family:'Orbitron';"><i class="fas fa-file-contract" style="color:var(--neon-blue)"></i> REPORTES</a>
        <a href="#" onclick="showSection('blacklist')" style="color:#fff; text-decoration:none; font-family:'Orbitron';"><i class="fas fa-user-slash" style="color:var(--neon-red)"></i> BLOQUEADOS</a>
        <a href="#" onclick="logout()" style="color:var(--neon-red); text-decoration:none; font-family:'Orbitron'; margin-top:30px;"><i class="fas fa-power-off"></i> SALIR</a>
    </div>
</nav>

<div class="container" id="appInterface" style="visibility: hidden;">
    <aside class="glass-card" style="text-align:center;">
        <img src="logo.png" id="p-avatar" style="width:110px; height:110px; border-radius:50%; border:2px solid var(--neon-gold); box-shadow: var(--shadow-gold);">
        <h2 id="p-name" style="font-family:'Orbitron'; margin-top:15px; font-size:1.2rem;">PILOTO</h2>
        
        <div id="p-role-badge" class="role-badge">
            <i id="p-role-icon" class="fas"></i>
            <span id="p-role-text">---</span>
        </div>

        <div id="lvl-display" style="color:var(--neon-blue); margin:15px 0 10px 0; font-family: 'Orbitron'; font-size: 0.8rem;">LVL 01</div>
        <div style="width:100%; height:8px; background:#111; border:1px solid var(--neon-gold); border-radius:4px; overflow:hidden;">
            <div id="xp-fill" style="height:100%; background:var(--neon-gold); width:0%; transition:1s;"></div>
        </div>
    </aside>

    <main>
        <section id="sec-profile" class="glass-card">
            <h3 id="welcome-msg" style="font-family:'Orbitron'; color:var(--neon-gold);">INFO DE NÚCLEO</h3>
            <p style="color:#888; margin-top:10px;">Sistema funcionando correctamente. No se detectan anomalías.</p>
        </section>

        <section id="sec-reports" class="glass-card" style="display:none;">
            <h3 style="font-family:'Orbitron'; color:var(--neon-gold); margin-bottom:20px;">ESTADO DE REPORTES</h3>
            <div id="reports-container"></div>
        </section>

        <section id="sec-blacklist" class="glass-card" style="display:none;">
            <h3 style="font-family:'Orbitron'; color:var(--neon-red); margin-bottom:20px;">USUARIOS BLOQUEADOS</h3>
            <div id="blacklist-container"></div>
        </section>

        <section id="sec-missions" class="glass-card" style="display:none;">
            <h3 style="font-family:'Orbitron'; color:var(--neon-gold); margin-bottom:20px;">MISIONES</h3>
            <div class="report-item">
                <div style="flex-grow:1;">
                    <strong style="color:var(--neon-blue);">RECOLECTAR DATOS</strong>
                    <p style="font-size:0.8rem;">Gana +20 XP</p>
                </div>
                <button class="btn-neon" id="btn-m1" onclick="handleMission(20, 'm1')">RECLAMAR</button>
            </div>
        </section>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, collection, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyChOQg743fsmGK89KVLoNAri_VGklArRi4", authDomain: "web1-3b83a.firebaseapp.com", projectId: "web1-3b83a" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    let uData = {};

    onAuthStateChanged(auth, (user) => {
        if (user) {
            onSnapshot(doc(db, "users", user.uid), (snap) => {
                uData = snap.data() || {};
                
                // --- PROTOCOLO DE SEGURIDAD Y ROLES ---
                const role = uData.role ? uData.role.toLowerCase() : null;

                if (!role) {
                    location.href = "index.html"; // No tiene rol
                } else if (role === 'anonimo') {
                    location.href = "main.html"; // Es anónimo
                } else {
                    document.getElementById('appInterface').style.visibility = 'visible';
                    renderUI(role);
                    checkMissions();
                }
            });
            listenReports(user.uid);
            listenBlacklist(user.uid);
        } else { location.href = "index.html"; }
    });

    function renderUI(role) {
        const nameEl = document.getElementById('p-name');
        const badgeEl = document.getElementById('p-role-badge');
        const iconEl = document.getElementById('p-role-icon');
        const textEl = document.getElementById('p-role-text');
        const avatar = document.getElementById('p-avatar');
        const xpFill = document.getElementById('xp-fill');

        nameEl.innerText = (uData.displayName || "PILOTO").toUpperCase();
        document.getElementById('lvl-display').innerText = "LVL " + (uData.level || 1);
        xpFill.style.width = (uData.xp || 0) + "%";
        textEl.innerText = role;

        // Limpiar clases
        nameEl.className = "";
        badgeEl.className = "role-badge";
        iconEl.className = "fas";

        if (role === 'dueno') {
            nameEl.classList.add('effect-dueno');
            badgeEl.classList.add('effect-dueno');
            iconEl.classList.add('fa-crown');
            avatar.style.borderColor = 'var(--neon-red)';
            xpFill.style.background = 'var(--neon-red)';
        } else if (role === 'admin') {
            nameEl.classList.add('effect-admin');
            badgeEl.classList.add('effect-admin');
            iconEl.classList.add('fa-shield-halved');
            avatar.style.borderColor = 'var(--neon-orange)';
            xpFill.style.background = 'var(--neon-orange)';
        } else if (role === 'suscriptor') {
            nameEl.classList.add('effect-suscriptor');
            badgeEl.classList.add('effect-suscriptor');
            iconEl.classList.add('fa-star');
            avatar.style.borderColor = 'var(--neon-gold)';
            xpFill.style.background = 'var(--neon-gold)';
        }
    }

    // --- LOGICA DE REPORTES CON LOGOS ---
    function listenReports(uid) {
        const q = query(collection(db, "reports"), where("userId", "==", uid));
        onSnapshot(q, (snap) => {
            const container = document.getElementById('reports-container');
            container.innerHTML = snap.empty ? "<p style='color:#444;'>No hay reportes enviados.</p>" : "";
            snap.forEach(d => {
                const r = d.data();
                let icon = "fa-clock", color = "var(--neon-gold)", text = "REVISIÓN";
                if(r.status === 'aceptado') { icon = "fa-shield-check"; color = "var(--neon-green)"; text = "ACEPTADO"; }
                if(r.status === 'rechazado') { icon = "fa-times-circle"; color = "var(--neon-red)"; text = "RECHAZADO"; }
                const date = r.createdAt ? new Date(r.createdAt).toLocaleString() : "Recién enviado";
                container.innerHTML += `<div class="report-item" style="border-left: 3px solid ${color}"><i class="fas ${icon} report-icon" style="color:${color}"></i><div style="flex-grow:1;"><strong style="color:#fff">${r.type || 'Reporte'}</strong><span class="date-text">${date}</span></div><span class="status-text" style="color:${color}">${text}</span></div>`;
            });
        });
    }

    // --- LOGICA DE BLOQUEADOS ---
    function listenBlacklist(uid) {
        const q = query(collection(db, "blacklist"), where("blockedBy", "==", uid));
        onSnapshot(q, (snap) => {
            const container = document.getElementById('blacklist-container');
            container.innerHTML = snap.empty ? "<p style='color:#444;'>No tienes usuarios bloqueados.</p>" : "";
            snap.forEach(d => {
                const b = d.data();
                container.innerHTML += `<div class="block-item"><i class="fas fa-user-slash" style="color:var(--neon-red)"></i><div style="flex-grow:1;"><strong>${b.userName || 'Usuario'}</strong><span class="date-text">ID: ${b.blockedId}</span></div><button class="btn-neon btn-red" onclick="unblockUser('${d.id}')">DESBLOQUEAR</button></div>`;
            });
        });
    }

    window.unblockUser = async (docId) => {
        if(confirm("¿Deseas desbloquear a este usuario?")) {
            await deleteDoc(doc(db, "blacklist", docId));
            alert("Usuario desbloqueado.");
        }
    };

    function checkMissions() {
        const now = Date.now();
        const btn = document.getElementById('btn-m1');
        if(uData.lastM1 && (now - uData.lastM1 < 86400000)) {
            btn.disabled = true; btn.innerText = "ESPERA 24H";
        } else { btn.disabled = false; btn.innerText = "RECLAMAR"; }
    }

    window.handleMission = async (amt, mId) => {
        let xp = (uData.xp || 0) + amt;
        let lvl = uData.level || 1;
        if(xp >= 100) { xp = 0; lvl++; }
        await updateDoc(doc(db, "users", auth.currentUser.uid), { xp, level: lvl, lastM1: Date.now() });
        alert("XP Reclamada.");
    };

    window.toggleNav = () => { const nav = document.getElementById('sideNav'); nav.style.left = nav.style.left === '0px' ? '-100%' : '0px'; };
    window.toggleNotifs = () => document.getElementById('notifPanel').classList.toggle('active');
    window.showSection = (id) => { document.querySelectorAll('main > section').forEach(s => s.style.display = 'none'); document.getElementById('sec-' + id).style.display = 'block'; toggleNav(); };
    window.logout = () => signOut(auth).then(() => location.href = "index.html");

</script>
</body>
</html>
