<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DANIBOOM | Ultra Gaming Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --neon-gold: #ffd700; --neon-blue: #00f2ff; --neon-red: #ff003c;
            --glass: rgba(255, 255, 255, 0.03); --glass-border: rgba(255, 255, 255, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Rajdhani', sans-serif; }
        body { background: radial-gradient(circle at center, #0a0a0a 0%, #000 100%); color: #fff; overflow-x: hidden; min-height: 100vh; }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: #000; z-index: 10000; display: grid; grid-template-columns: repeat(6, 1fr); grid-template-rows: repeat(6, 1fr); }
        .tile { background: #050505; border: 0.1px solid #111; transition: 0.6s; }
        .loaded .tile { transform: scale(0); opacity: 0; }

        /* HUB NAV */
        .side-hub { position: fixed; left: 20px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; gap: 20px; z-index: 100; }
        .hub-btn { width: 55px; height: 55px; background: var(--glass); border: 1px solid var(--glass-border); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #555; cursor: pointer; transition: 0.4s; backdrop-filter: blur(10px); }
        .hub-btn.active { color: var(--neon-gold); border-color: var(--neon-gold); box-shadow: 0 0 20px rgba(255, 214, 0, 0.3); }

        header { padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); }
        .container { max-width: 1300px; margin: 30px auto; padding: 0 80px; display: grid; grid-template-columns: 350px 1fr; gap: 30px; }

        /* CARDS */
        .glass-card { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 20px; padding: 25px; backdrop-filter: blur(10px); margin-bottom: 20px; }
        .profile-aside { text-align: center; padding: 40px; }
        .avatar-img { width: 180px; height: 180px; border-radius: 50%; border: 4px solid var(--neon-gold); box-shadow: 0 0 30px var(--neon-gold); object-fit: cover; }
        
        /* MISSIONS STYLE */
        .mission-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.02); border-radius: 12px; margin-top: 10px; border-left: 3px solid var(--neon-blue); }
        .btn-claim { padding: 5px 15px; border-radius: 5px; border: none; background: var(--neon-gold); color: #000; font-weight: bold; cursor: pointer; font-size: 0.7rem; }

        /* WHATSAPP PRO STYLE */
        .chat-hub { display: grid; grid-template-columns: 280px 1fr; height: 600px; border-radius: 20px; overflow: hidden; border: 1px solid var(--glass-border); }
        .friends-list { background: rgba(0,0,0,0.6); border-right: 1px solid var(--glass-border); overflow-y: auto; }
        .chat-area { display: flex; flex-direction: column; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: rgba(5,5,5,0.9); }
        .chat-msgs { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg-bubble { padding: 8px 15px; border-radius: 12px; max-width: 75%; font-size: 0.9rem; position: relative; backdrop-filter: blur(5px); }
        .msg-sent { align-self: flex-end; background: rgba(0, 92, 75, 0.8); border: 1px solid #00a884; }
        .msg-rec { align-self: flex-start; background: rgba(32, 44, 51, 0.9); border: 1px solid #333; }
        .msg-time { font-size: 0.6rem; color: #aaa; text-align: right; margin-top: 4px; }

        .xp-bar-bg { width: 100%; height: 8px; background: #111; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .xp-bar-fill { height: 100%; background: linear-gradient(90deg, var(--neon-gold), #fff); width: 0%; transition: 1s; }

        @media (max-width: 900px) { .container { grid-template-columns: 1fr; padding: 20px; } .side-hub { bottom: 10px; top: auto; left: 50%; transform: translateX(-50%); flex-direction: row; } }
    </style>
</head>
<body>

<div id="loader"></div>

<header>
    <div style="font-family:'Orbitron'; color:var(--neon-gold); font-weight:900;">DANIBOOM_OS</div>
    <div id="top-lvl" style="border: 1px solid var(--neon-gold); padding: 5px 15px; border-radius: 10px; font-weight: bold;">LVL 00</div>
</header>

<div class="side-hub">
    <div class="hub-btn active" id="btn-home" onclick="nav('home')"><i class="fas fa-user-ninja"></i></div>
    <div class="hub-btn" id="btn-social" onclick="nav('social')"><i class="fab fa-whatsapp"></i></div>
    <div class="hub-btn" id="btn-settings" onclick="nav('settings')"><i class="fas fa-cogs"></i></div>
</div>

<div class="container">
    <aside class="glass-card profile-aside">
        <img src="logo.png" id="avatar-img" class="avatar-img">
        <h2 id="u-name" style="margin-top:20px; font-family:'Orbitron';">CARGANDO...</h2>
        <div class="xp-bar-bg"><div id="xp-fill" class="xp-bar-fill"></div></div>
        <p id="xp-text" style="font-size:0.7rem; color:var(--neon-gold); margin-top:5px;">0/100 XP</p>
    </aside>

    <main>
        <section id="sec-home">
            <div class="glass-card">
                <h3 style="color:var(--neon-blue);"><i class="fas fa-chart-line"></i> DASHBOARD ESTADÍSTICAS</h3>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:15px; text-align:center;">
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px;">
                        <small>ESTADO</small><h4 id="u-rank">RECRUIT</h4>
                    </div>
                    <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px;">
                        <small>AMIGOS</small><h4 id="u-friends-count">0</h4>
                    </div>
                </div>
            </div>

            <div class="glass-card">
                <h3 style="color:var(--neon-gold);"><i class="fas fa-trophy"></i> PROGRAMA DE MISIONES</h3>
                <div class="mission-row">
                    <div><strong>RECONOCIMIENTO</strong><br><small>Entrar al Hub hoy</small></div>
                    <button class="btn-claim" onclick="claimXP(10, 'm1')">RECLAMAR 10XP</button>
                </div>
                <div class="mission-row">
                    <div><strong>MENSAJERO CYBER</strong><br><small>Enviar 1 mensaje a un amigo</small></div>
                    <button class="btn-claim" onclick="claimXP(20, 'm2')">RECLAMAR 20XP</button>
                </div>
            </div>
        </section>

        <section id="sec-social" style="display:none;">
            <div class="chat-hub">
                <div class="friends-list" id="friends-list">
                    <div style="padding:20px; text-align:center; color:#444;">No tienes amigos agregados.</div>
                </div>
                <div class="chat-area">
                    <div id="chat-header" style="padding:15px; background:rgba(0,0,0,0.5); border-bottom:1px solid var(--glass-border); font-weight:bold; color:var(--neon-gold);">
                        SELECCIONA UN CONTACTO
                    </div>
                    <div class="chat-msgs" id="chat-msgs"></div>
                    <div style="padding:15px; display:flex; gap:10px; background:rgba(0,0,0,0.8);">
                        <input type="text" id="m-input" placeholder="Escribe un mensaje..." style="flex:1; background:#111; border:1px solid #333; padding:12px; color:#fff; border-radius:25px; outline:none;">
                        <button onclick="sendMsg()" style="background:var(--neon-gold); border:none; width:45px; height:45px; border-radius:50%;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </section>

        <section id="sec-settings" style="display:none;">
            <div class="glass-card">
                <h3>CONFIGURACIÓN DEL SISTEMA</h3>
                <button onclick="logout()" style="width:100%; padding:15px; background:var(--neon-red); color:#fff; border:none; border-radius:10px; margin-top:20px; font-weight:bold;">CERRAR SESIÓN</button>
            </div>
        </section>
    </main>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, updateDoc, collection, query, getDocs, addDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyChOQg743fsmGK89KVLoNAri_VGklArRi4", authDomain: "web1-3b83a.firebaseapp.com", projectId: "web1-3b83a" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    let uData = {};
    let activeChat = null;

    // Loader
    const ld = document.getElementById('loader');
    for(let i=0; i<36; i++) ld.innerHTML += '<div class="tile"></div>';

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            onSnapshot(doc(db, "users", user.uid), (snap) => {
                uData = snap.data() || {};
                updateUI();
                document.body.classList.add('loaded');
            });
            loadFriends(user.uid);
        } else { location.href = "index.html"; }
    });

    function updateUI() {
        document.getElementById('u-name').innerText = uData.displayName || "GUEST";
        document.getElementById('top-lvl').innerText = `LVL ${uData.level || 0}`;
        document.getElementById('xp-text').innerText = `${uData.xp || 0}/100 XP`;
        document.getElementById('xp-fill').style.width = `${uData.xp || 0}%`;
        document.getElementById('u-rank').innerText = (uData.membership || "USER").toUpperCase();
    }

    async function loadFriends(uid) {
        // Buscamos solo en la sub-colección 'amigos' del usuario actual
        const q = query(collection(db, "users", uid, "amigos"));
        const snap = await getDocs(q);
        const list = document.getElementById('friends-list');
        list.innerHTML = "";
        
        if(snap.empty) { list.innerHTML = "<div style='padding:20px; color:#444; font-size:0.8rem;'>No tienes amigos agregados.</div>"; return; }
        
        document.getElementById('u-friends-count').innerText = snap.size;
        
        snap.forEach(d => {
            const friend = d.data();
            const div = document.createElement('div');
            div.style = "padding:15px; border-bottom:1px solid #111; cursor:pointer; display:flex; align-items:center; gap:10px;";
            div.innerHTML = `<img src="logo.png" style="width:35px; border-radius:50%;"> <div><strong>${friend.name}</strong><br><small style="color:var(--neon-blue)">Online</small></div>`;
            div.onclick = () => openWhatsApp(d.id, friend.name);
            list.appendChild(div);
        });
    }

    window.openWhatsApp = (id, name) => {
        activeChat = id;
        document.getElementById('chat-header').innerText = "CONECTADO CON: " + name;
        const chatID = [auth.currentUser.uid, id].sort().join("_");
        
        onSnapshot(query(collection(db, "chats", chatID, "messages"), orderBy("time", "asc")), (snap) => {
            const box = document.getElementById('chat-msgs');
            box.innerHTML = "";
            snap.forEach(m => {
                const msg = m.data();
                const time = new Date(msg.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const isMe = msg.from === auth.currentUser.uid;
                box.innerHTML += `<div class="msg-bubble ${isMe ? 'msg-sent' : 'msg-rec'}">
                    ${msg.text} <div class="msg-time">${time}</div>
                </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    };

    window.sendMsg = async () => {
        const inp = document.getElementById('m-input');
        if(!inp.value || !activeChat) return;
        const chatID = [auth.currentUser.uid, activeChat].sort().join("_");
        await addDoc(collection(db, "chats", chatID, "messages"), { text: inp.value, from: auth.currentUser.uid, time: Date.now() });
        inp.value = "";
    };

    window.claimXP = async (amount, id) => {
        let xp = (uData.xp || 0) + amount;
        let lvl = (uData.level || 0);
        if(xp >= 100) { xp = 0; lvl++; }
        await updateDoc(doc(db, "users", auth.currentUser.uid), { xp, level: lvl });
        alert(`¡Misión cumplida! +${amount} XP`);
    };

    window.nav = (id) => {
        document.querySelectorAll('main > section').forEach(s => s.style.display = 'none');
        document.getElementById('sec-' + id).style.display = 'block';
        document.querySelectorAll('.hub-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + id).classList.add('active');
    };

    window.logout = () => signOut(auth).then(() => location.href="index.html");
</script>
</body>
</html>
