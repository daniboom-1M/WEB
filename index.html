<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANIBOOM | Login</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{margin:0;padding:0;font-family:'Orbitron',sans-serif;background:#0b0b0b;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;}
.container{background:rgba(0,0,0,.85);padding:2rem;border-radius:14px;border:2px solid gold;width:350px;box-shadow:0 0 20px gold;text-align:center;animation:fadeIn 1s ease forwards;}
.logo{margin-bottom:1rem;}
.logo img{width:60px;height:60px;border-radius:50%;border:2px solid gold;}
h1{color:gold;font-size:1rem;margin-bottom:1rem;text-shadow:0 0 8px gold;}
form{display:flex;flex-direction:column;gap:1rem;margin-bottom:1rem;}
input{padding:.8rem;border-radius:8px;border:2px solid gold;background:#111;color:#fff;font-size:.8rem;}
button{padding:.8rem;border:none;border-radius:8px;background:gold;color:#000;font-weight:700;cursor:pointer;font-size:.85rem;transition:.3s;}
button:hover{transform:scale(1.05);}
.divider{display:flex;align-items:center;text-align:center;margin:1rem 0;color:gold;font-size:.7rem;}
.divider::before,.divider::after{content:"";flex:1;border-bottom:1px solid gold;}
.divider:not(:empty)::before{margin-right:.5em;}
.divider:not(:empty)::after{margin-left:.5em;}
.switch-text{font-size:.7rem;color:#aaa;cursor:pointer;margin-top:0.5rem;}
.userNameSection{display:flex;flex-direction:column;gap:.5rem;}
.userNameSection input{border:2px solid gold;background:#111;color:#fff;}
.userNameSection label{font-size:.75rem;color:#aaa;text-align:left;}
.userNameSection span{color:red;font-size:.75rem;}
</style>
</head>
<body>

<div class="container" id="loginContainer">
  <div class="logo">
    <img src="logo.png" alt="DaniBoom Logo">
  </div>
  <h1 id="formTitle">Iniciar Sesión</h1>

  <!-- LOGIN FORM -->
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Correo electrónico" required>
    <input type="password" id="loginPassword" placeholder="Contraseña" required>
    <button type="submit">Iniciar Sesión</button>
    <p class="switch-text" id="switchForm">¿No tienes cuenta? Crear Cuenta</p>
  </form>

  <!-- REGISTER FORM -->
  <form id="registerForm" style="display:none;">
    <input type="email" id="regEmail" placeholder="Correo electrónico" required>
    <input type="password" id="regPassword" placeholder="Contraseña" required>
    
    <div class="userNameSection">
      <label for="usernameInput">Nombre de usuario (obligatorio)</label>
      <input type="text" id="usernameInput" placeholder="Escribe tu nombre de usuario" required>
      <span id="usernameError" style="display:none;">Debes escribir un nombre de usuario</span>
    </div>

    <button type="submit">Crear Cuenta</button>
    <div class="divider">O</div>
    <button type="button" id="regAnonymous"><i class="fa-solid fa-user-secret"></i> Continuar como Anónimo</button>
    <p class="switch-text" id="toLoginText" style="font-size:.7rem;margin-top:0.5rem;">¿Ya tienes una cuenta? Iniciar sesión</p>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// Config Firebase
const firebaseConfig = {
  apiKey: "AIzaSyChOQg743fsmGK89KVLoNAri_VGklArRi4",
  authDomain: "web1-3b83a.firebaseapp.com",
  projectId: "web1-3b83a",
  storageBucket: "web1-3b83a.firebasestorage.app",
  messagingSenderId: "519590670968",
  appId: "1:519590670968:web:cb291125919a12e9e7b38d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

// ELEMENTOS
const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const switchText = document.getElementById("switchForm");
const toLoginText = document.getElementById("toLoginText");
const formTitle = document.getElementById("formTitle");
const usernameInput = document.getElementById("usernameInput");
const usernameError = document.getElementById("usernameError");
const regAnonymous = document.getElementById("regAnonymous");

// SWITCH FORMS
switchText.addEventListener("click", ()=>{
  loginForm.style.display="none";
  registerForm.style.display="flex";
  formTitle.textContent="Crear Cuenta";
});

toLoginText.addEventListener("click", ()=>{
  registerForm.style.display="none";
  loginForm.style.display="flex";
  formTitle.textContent="Iniciar Sesión";
});

// FUNCION CREAR USUARIO EN FIRESTORE
async function createUserInFirestore(user, role, username){
  const userRef = doc(db,"users",user.uid);
  const docSnap = await getDoc(userRef);
  if(!docSnap.exists()){
    await setDoc(userRef,{
      displayName: username,
      membership: role,
      photoURL: "default.png",
      createdAt: serverTimestamp()
    });
  }
}

// FUNCION PARA CONTAR ANONIMOS
async function getNextAnonymousNumber(){
  const usersCol = collection(db,"users");
  const snapshot = await getDocs(usersCol);
  let count = 0;
  snapshot.forEach(doc => {
    const data = doc.data();
    if(data.membership==="anonymous") count++;
  });
  return count + 1;
}

// LOGIN CON CORREO
loginForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  if(!email){ alert("Debes escribir tu correo"); return; }
  if(!password){ alert("Debes escribir tu contraseña"); return; }
  try{
    const cred = await signInWithEmailAndPassword(auth,email,password);
    window.location.href="main.html";
  }catch(err){ alert(err.message); }
});

// CREAR CUENTA CORREO
registerForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  const email = document.getElementById("regEmail").value.trim();
  const password = document.getElementById("regPassword").value.trim();
  const username = usernameInput.value.trim();

  if(!email){ alert("Debes escribir tu correo"); return; }
  if(!password || password.length<6){ alert("Contraseña mínima 6 caracteres"); return; }
  if(!username){ usernameError.style.display="block"; return; }
  usernameError.style.display="none";

  try{
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    await createUserInFirestore(cred.user,"suscriptor",username);
    window.location.href="main.html";
  }catch(err){ alert(err.message); }
});

// ANONIMO
regAnonymous.addEventListener("click", async()=>{
  const anonNumber = await getNextAnonymousNumber();
  const anonName = `Anónimo #${String(anonNumber).padStart(3,"0")}`;
  try{
    const cred = await signInAnonymously(auth);
    await createUserInFirestore(cred.user,"anonymous",anonName);
    window.location.href="main.html";
  }catch(err){ alert(err.message); }
});

// AUTO DETECCIÓN DE USUARIO
onAuthStateChanged(auth,user=>{
  if(user) window.location.href="main.html";
});

</script>
</body>
</html>
