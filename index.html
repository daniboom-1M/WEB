<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANIBOOM | Login</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
:root{
  --gold:#ffd700;
  --neon-gold:0 0 6px gold,0 0 14px gold,0 0 28px gold;
  --neon-gray:0 0 4px #555;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:'Orbitron',sans-serif;
  background:#0b0b0b;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}

/* CONTENEDOR */
.container{
  background:rgba(0,0,0,.9);
  width:360px;
  padding:2rem;
  border-radius:16px;
  border:2px solid var(--gold);
  box-shadow:var(--neon-gold);
  text-align:center;
}

/* LOGO */
.logo{
  display:flex;
  justify-content:center;
  margin-bottom:1rem;
}
.logo-circle{
  width:80px;
  height:80px;
  border-radius:50%;
  border:2px solid var(--gold);
  box-shadow:var(--neon-gold);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
  background:#000;
}
.logo-circle img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* TITULO */
h1{
  font-size:1rem;
  color:var(--gold);
  text-shadow:var(--neon-gold);
  margin-bottom:1rem;
}

/* INPUTS */
input{
  width:100%;
  padding:.8rem;
  background:#111;
  color:#fff;
  border-radius:10px;
  border:2px solid var(--gold);
  box-shadow:0 0 6px gold;
  outline:none;
}
input:focus{
  box-shadow:0 0 12px gold;
}

/* BOTONES */
button{
  width:100%;
  padding:.8rem;
  background:var(--gold);
  color:#000;
  border:none;
  border-radius:10px;
  font-weight:800;
  cursor:pointer;
  box-shadow:var(--neon-gold);
}
button:hover{transform:scale(1.05);}

/* TEXTOS */
.switch-text{
  font-size:.7rem;
  color:#aaa;
  cursor:pointer;
  margin-top:.5rem;
}
.switch-text:hover{color:var(--gold);}

/* ERRORES */
.error{
  font-size:.7rem;
  color:red;
  display:none;
  margin-top:.4rem;
}

/* DIVIDER */
.divider{
  margin:1rem 0;
  color:var(--gold);
  font-size:.7rem;
}

/* ANÓNIMO */
.anon-btn{
  background:#111;
  color:#ccc;
  border:2px solid #555;
  box-shadow:var(--neon-gray);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:.6rem;
}
.anon-logo{
  width:18px;
  height:18px;
  border-radius:50%;
  border:2px solid #555;
  position:relative;
}
.anon-logo::before{
  content:"";
  position:absolute;
  width:6px;
  height:6px;
  border-radius:50%;
  background:#555;
  top:2px;
  left:4px;
}
.anon-logo::after{
  content:"";
  position:absolute;
  width:10px;
  height:6px;
  border-radius:6px 6px 0 0;
  border:2px solid #555;
  border-bottom:none;
  bottom:2px;
  left:2px;
}

/* FORMS */
form{
  display:flex;
  flex-direction:column;
  gap:1rem;
}
</style>
</head>

<body>

<div class="container">

  <!-- LOGO -->
  <div class="logo">
    <div class="logo-circle">
      <img src="logo.png" alt="DaniBoom Logo" onerror="this.style.display='none'">
    </div>
  </div>

  <h1 id="title">Iniciar Sesión</h1>

  <!-- LOGIN -->
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Correo electrónico">
    <input type="password" id="loginPassword" placeholder="Contraseña">
    <button>Iniciar Sesión</button>
    <span class="error" id="loginError"></span>
    <p class="switch-text" id="toRegister">¿No tienes cuenta? Crear cuenta</p>
  </form>

  <!-- REGISTER -->
  <form id="registerForm" style="display:none;">
    <input type="email" id="regEmail" placeholder="Correo electrónico">
    <input type="password" id="regPassword" placeholder="Contraseña (mín. 6)">
    <input type="text" id="username" placeholder="Nombre de usuario">
    <span class="error" id="regError"></span>
    <button>Crear Cuenta</button>
    <div class="divider">O</div>
    <button type="button" class="anon-btn" id="anonBtn">
      <div class="anon-logo"></div>
      Entrar como Anónimo
    </button>
    <p class="switch-text" id="toLogin">¿Ya tienes cuenta? Iniciar sesión</p>
  </form>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  signInAnonymously,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  collection,
  getDocs,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

initializeApp({
  apiKey:"AIzaSyChOQg743fsmGK89KVLoNAri_VGklArRi4",
  authDomain:"web1-3b83a.firebaseapp.com",
  projectId:"web1-3b83a"
});

const auth=getAuth();
const db=getFirestore();

/* AUTO LOGIN (NO ANÓNIMO) */
onAuthStateChanged(auth,async u=>{
  if(u && !u.isAnonymous){
    const d=await getDoc(doc(db,"users",u.uid));
    if(d.exists()) location.href="main.html";
  }
});

/* SWITCH */
toRegister.onclick=()=>{
  loginForm.style.display="none";
  registerForm.style.display="flex";
  title.textContent="Crear Cuenta";
};
toLogin.onclick=()=>{
  registerForm.style.display="none";
  loginForm.style.display="flex";
  title.textContent="Iniciar Sesión";
};

/* LOGIN */
loginForm.onsubmit=async e=>{
  e.preventDefault();
  loginError.style.display="none";

  if(!loginEmail.value||!loginPassword.value){
    loginError.textContent="Debes llenar todos los campos";
    loginError.style.display="block"; return;
  }

  try{
    await signInWithEmailAndPassword(auth,loginEmail.value,loginPassword.value);
    location.href="main.html";
  }catch(err){
    if(err.code==="auth/wrong-password"){
      loginError.innerHTML=`Contraseña incorrecta. 
      <span style="color:gold;cursor:pointer" onclick="location.href='contraseña.html'">
      ¿Cambiar contraseña?</span>`;
    }else if(err.code==="auth/user-not-found"){
      loginError.textContent="Esta cuenta no existe";
    }else{
      loginError.textContent="Error al iniciar sesión";
    }
    loginError.style.display="block";
  }
};

/* REGISTER */
registerForm.onsubmit=async e=>{
  e.preventDefault();
  regError.style.display="none";

  if(!regEmail.value||!regPassword.value||!username.value){
    regError.textContent="Todos los campos son obligatorios";
    regError.style.display="block"; return;
  }

  if(regPassword.value.length<6){
    regError.textContent="Contraseña mínima 6 caracteres";
    regError.style.display="block"; return;
  }

  try{
    const cred=await createUserWithEmailAndPassword(auth,regEmail.value,regPassword.value);
    await setDoc(doc(db,"users",cred.user.uid),{
      displayName:username.value,
      membership:"suscriptor",
      photoURL:"default.png",
      createdAt:serverTimestamp()
    });
    location.href="main.html";
  }catch{
    regError.textContent="Error al crear la cuenta";
    regError.style.display="block";
  }
};

/* ANÓNIMO */
anonBtn.onclick=async()=>{
  const cred=await signInAnonymously(auth);
  const snap=await getDocs(collection(db,"users"));
  let n=1;
  snap.forEach(d=>{if(d.data().membership==="anonymous")n++;});
  await setDoc(doc(db,"users",cred.user.uid),{
    displayName:`Anónimo #${String(n).padStart(3,"0")}`,
    membership:"anonymous",
    photoURL:"anonymous.png",
    createdAt:serverTimestamp()
  });
  location.href="main.html";
};
</script>

</body>
</html>
