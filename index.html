<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANIBOOM | Login</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{margin:0;padding:0;font-family:'Orbitron',sans-serif;background:#0b0b0b;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;}
.container{background:rgba(0,0,0,.8);padding:2rem;border-radius:14px;border:2px solid gold;width:320px;box-shadow:0 0 20px gold;text-align:center;animation:fadeIn 1s ease forwards;}
.logo{margin-bottom:1rem;}
.logo img{width:60px;height:60px;border-radius:50%;border:2px solid gold;}
h1{color:gold;font-size:1rem;margin-bottom:1rem;text-shadow:0 0 8px gold;}
form{display:flex;flex-direction:column;gap:1rem;margin-bottom:1rem;}
input{padding:.8rem;border-radius:8px;border:2px solid gold;background:#111;color:#fff;font-size:.8rem;}
button{padding:.8rem;border:none;border-radius:8px;background:gold;color:#000;font-weight:700;cursor:pointer;font-size:.85rem;transition:.3s;}
button:hover{transform:scale(1.05);}
.switch-text{font-size:.65rem;color:#aaa;cursor:pointer;text-align:center;}
#usernameInput{display:none;}
#anonymousBtn{margin-top:0.5rem;}
.divider{display:flex;align-items:center;text-align:center;margin:1rem 0;color:gold;font-size:.75rem;}
.divider::before,.divider::after{content:"";flex:1;border-bottom:1px solid gold;}
.divider:not(:empty)::before{margin-right:.5em;}
.divider:not(:empty)::after{margin-left:.5em;}
#errorMsg{color:red;font-size:0.7rem;}
#goToLogin{margin-top:0.5rem;font-size:0.65rem;color:#aaa;cursor:pointer;text-decoration:underline;}
</style>
</head>
<body>

<div class="container">
  <div class="logo">
    <img src="logo.png" alt="DaniBoom Logo">
  </div>
  <h1 id="formTitle">Iniciar Sesión</h1>

  <div id="errorMsg"></div>

  <!-- LOGIN FORM -->
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Correo electrónico" required>
    <input type="password" id="loginPassword" placeholder="Contraseña" required>
    <button type="submit">Iniciar Sesión</button>
    <div class="switch-text" id="goToRegister">¿No tienes cuenta? Crear Cuenta</div>
  </form>

  <!-- REGISTER FORM -->
  <form id="registerForm" style="display:none;">
    <input type="email" id="regEmail" placeholder="Correo electrónico" required>
    <input type="password" id="regPassword" placeholder="Contraseña" required>

    <!-- Input para nombre de usuario, aparece tras validar correo/contraseña -->
    <input type="text" id="usernameInput" placeholder="Elige tu nombre de usuario">

    <button type="submit" id="createAccountBtn">Crear Cuenta</button>

    <div class="divider">O</div>

    <button type="button" id="anonymousBtn"><i class="fa-solid fa-user-secret"></i> Continuar como Anónimo</button>

    <div id="goToLogin">¿Ya tienes una cuenta? Iniciar sesión</div>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { 
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signInAnonymously, onAuthStateChanged, updateProfile
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, serverTimestamp, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyChOQg743fsmGK89KVLoNAri_VGklArRi4",
  authDomain: "web1-3b83a.firebaseapp.com",
  projectId: "web1-3b83a",
  storageBucket: "web1-3b83a.firebasestorage.app",
  messagingSenderId: "519590670968",
  appId: "1:519590670968:web:cb291125919a12e9e7b38d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

// ELEMENTOS
const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const goToRegister = document.getElementById("goToRegister");
const goToLogin = document.getElementById("goToLogin");
const usernameInput = document.getElementById("usernameInput");
const anonymousBtn = document.getElementById("anonymousBtn");
const createAccountBtn = document.getElementById("createAccountBtn");
const errorMsg = document.getElementById("errorMsg");

// SWITCH LOGIN → REGISTER
goToRegister.addEventListener("click", ()=>{
  loginForm.style.display="none";
  registerForm.style.display="flex";
  document.getElementById("formTitle").textContent="Crear Cuenta";
  errorMsg.textContent="";
});

// SWITCH REGISTER → LOGIN
goToLogin.addEventListener("click", ()=>{
  registerForm.style.display="none";
  loginForm.style.display="flex";
  document.getElementById("formTitle").textContent="Iniciar Sesión";
  errorMsg.textContent="";
});

// CREAR USUARIO FIRESTORE
async function createUserInFirestore(user, membership="member", displayName="") {
  const userRef = doc(db,"users",user.uid);
  const docSnap = await getDoc(userRef);
  if(!docSnap.exists()){
    await setDoc(userRef,{
      displayName: displayName,
      membership: membership,
      photoURL: "default.png",
      createdAt: serverTimestamp()
    });
    return true;
  }
  return false;
}

// CONTADOR ANÓNIMOS
async function getNextAnonymousNumber(){
  const usersCol = collection(db,"users");
  const querySnapshot = await getDocs(usersCol);
  let count = 0;
  querySnapshot.forEach(doc=>{
    const data = doc.data();
    if(data.membership === "anonymous") count++;
  });
  return count + 1;
}

// LOGIN EMAIL
loginForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  if(!email){ errorMsg.textContent="Debes escribir tu correo"; return; }
  if(!password){ errorMsg.textContent="Debes escribir tu contraseña"; return; }
  try{
    await signInWithEmailAndPassword(auth,email,password);
    window.location.href="main.html";
  } catch(err){ errorMsg.textContent=err.message; }
});

// REGISTER EMAIL
registerForm.addEventListener("submit", async e=>{
  e.preventDefault();
  errorMsg.textContent="";
  const email = document.getElementById("regEmail").value.trim();
  const password = document.getElementById("regPassword").value.trim();
  const username = usernameInput.value.trim();

  if(!email){ errorMsg.textContent="Debes escribir tu correo"; return; }
  if(!password){ errorMsg.textContent="Debes escribir tu contraseña"; return; }
  if(password.length < 6){ errorMsg.textContent="La contraseña debe tener mínimo 6 caracteres"; return; }

  if(usernameInput.style.display === "none"){
    usernameInput.style.display="block";
    usernameInput.focus();
    return;
  }

  if(!username){ errorMsg.textContent="Debes escribir un nombre de usuario"; return; }

  try{
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    await createUserInFirestore(cred.user,"member",username);
    await updateProfile(cred.user,{ displayName: username });
    window.location.href="main.html";
  } catch(err){ errorMsg.textContent=err.message; }
});

// ANÓNIMO
anonymousBtn.addEventListener("click", async ()=>{
  try{
    const num = await getNextAnonymousNumber();
    const anonName = `Anónimo #${String(num).padStart(3,'0')}`;
    const cred = await signInAnonymously(auth);
    await createUserInFirestore(cred.user,"anonymous",anonName);
    window.location.href="main.html";
  } catch(err){ alert(err.message); }
});

// AUTO DETECCIÓN USUARIO LOGUEADO
onAuthStateChanged(auth, async user=>{
  if(user){
    const docSnap = await getDoc(doc(db,"users",user.uid));
    if(docSnap.exists() && docSnap.data().displayName){
      window.location.href="main.html";
    } else {
      registerForm.style.display="flex";
      usernameInput.style.display="block";
      document.getElementById("formTitle").textContent="Crear Cuenta";
    }
  }
});
</script>
</body>
      </html>
