<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANIBOOM | Login</title>

<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&family=Press+Start+2P&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
body{margin:0;padding:0;font-family:'Orbitron',sans-serif;background:#0b0b0b;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;}
.container{background:rgba(0,0,0,.8);padding:2rem;border-radius:14px;border:2px solid gold;width:320px;box-shadow:0 0 20px gold;text-align:center;animation:fadeIn 1s ease forwards;}
.logo{margin-bottom:1rem;}
.logo img{width:60px;height:60px;border-radius:50%;border:2px solid gold;}
h1{color:gold;font-size:1rem;margin-bottom:1rem;text-shadow:0 0 8px gold;}
form{display:flex;flex-direction:column;gap:1rem;margin-bottom:1rem;}
input{padding:.8rem;border-radius:8px;border:2px solid gold;background:#111;color:#fff;font-size:.8rem;}
button{padding:.8rem;border:none;border-radius:8px;background:gold;color:#000;font-weight:700;cursor:pointer;font-size:.85rem;transition:.3s;}
button:hover{transform:scale(1.05);}
.switch-text{font-size:.7rem;color:#aaa;cursor:pointer;text-align:center;}
#usernameSection{display:none;flex-direction:column;gap:.5rem;margin-top:1rem;}
@keyframes fadeIn{0%{opacity:0;transform:translateY(-20px);}100%{opacity:1;transform:translateY(0);}}
</style>
</head>
<body>

<div class="container">
  <div class="logo">
    <img src="logo.png" alt="DaniBoom Logo">
  </div>
  <h1 id="formTitle">Iniciar Sesión</h1>

  <!-- LOGIN FORM -->
  <form id="loginForm">
    <input type="email" id="loginEmail" placeholder="Correo electrónico" required>
    <input type="password" id="loginPassword" placeholder="Contraseña" required>
    <button type="submit">Iniciar Sesión</button>
    <div class="switch-text" id="goToRegister">¿No tienes cuenta? Crear Cuenta</div>
  </form>

  <!-- REGISTER FORM -->
  <form id="registerForm" style="display:none;">
    <input type="email" id="regEmail" placeholder="Correo electrónico" required>
    <input type="password" id="regPassword" placeholder="Contraseña" required>
    <button type="submit">Crear Cuenta</button>
  </form>

  <!-- NOMBRE DE USUARIO + ANÓNIMO -->
  <div id="usernameSection">
    <input type="text" id="usernameInput" placeholder="Elige tu nombre de usuario">
    <button id="saveUsernameBtn">Guardar Nombre</button>
    <button id="anonymousBtn"><i class="fa-solid fa-user-secret"></i> Continuar como Anónimo</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { 
  getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
  signInAnonymously, onAuthStateChanged, updateProfile
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

// ===== CONFIG FIREBASE =====
const firebaseConfig = {
  apiKey: "AIzaSyChOQg743fsmGK89KVLoNAri_VGklArRi4",
  authDomain: "web1-3b83a.firebaseapp.com",
  projectId: "web1-3b83a",
  storageBucket: "web1-3b83a.firebasestorage.app",
  messagingSenderId: "519590670968",
  appId: "1:519590670968:web:cb291125919a12e9e7b38d"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

// ELEMENTOS
const loginForm = document.getElementById("loginForm");
const registerForm = document.getElementById("registerForm");
const goToRegister = document.getElementById("goToRegister");
const usernameSection = document.getElementById("usernameSection");
const usernameInput = document.getElementById("usernameInput");
const saveUsernameBtn = document.getElementById("saveUsernameBtn");
const anonymousBtn = document.getElementById("anonymousBtn");

// ===== SWITCH LOGIN → REGISTER =====
goToRegister.addEventListener("click", ()=>{
  loginForm.style.display="none";
  registerForm.style.display="flex";
  document.getElementById("formTitle").textContent="Crear Cuenta";
});

// ===== FUNCIONES FIRESTORE =====
async function createUserInFirestore(user, membership="member") {
  const userRef = doc(db,"users",user.uid);
  const docSnap = await getDoc(userRef);
  if(!docSnap.exists()){
    await setDoc(userRef,{
      displayName: user.displayName || "",
      membership: membership,
      photoURL: user.photoURL || "default.png",
      createdAt: serverTimestamp()
    });
    return true;
  }
  return false;
}

// ===== LOGIN EMAIL =====
loginForm.addEventListener("submit", async e=>{
  e.preventDefault();
  try{
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const cred = await signInWithEmailAndPassword(auth,email,password);
    const isNew = await createUserInFirestore(cred.user);
    if(isNew) usernameSection.style.display="flex";
    else window.location.href="main.html";
  } catch(err){ alert(err.message); }
});

// ===== REGISTER EMAIL =====
registerForm.addEventListener("submit", async e=>{
  e.preventDefault();
  try{
    const email = document.getElementById("regEmail").value;
    const password = document.getElementById("regPassword").value;
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    const isNew = await createUserInFirestore(cred.user);
    if(isNew) usernameSection.style.display="flex";
    else window.location.href="main.html";
  } catch(err){ alert(err.message); }
});

// ===== GUARDAR NOMBRE DE USUARIO =====
saveUsernameBtn.addEventListener("click", async ()=>{
  const name = usernameInput.value.trim();
  if(!name){ alert("Escribe un nombre de usuario"); return; }
  const user = auth.currentUser;
  if(!user){ alert("No hay usuario logueado"); return; }

  await setDoc(doc(db,"users",user.uid),{ displayName:name },{ merge:true });
  await updateProfile(user,{ displayName:name });

  window.location.href="main.html";
});

// ===== ANÓNIMO =====
anonymousBtn.addEventListener("click", async ()=>{
  try{
    const cred = await signInAnonymously(auth);
    const isNew = await createUserInFirestore(cred.user,"anonymous");
    if(isNew) usernameSection.style.display="flex";
    else window.location.href="main.html";
  } catch(err){ alert(err.message); }
});

// ===== AUTO DETECCIÓN USUARIO LOGUEADO =====
onAuthStateChanged(auth,user=>{
  if(user){
    const checkUser = async ()=>{
      const docSnap = await getDoc(doc(db,"users",user.uid));
      if(!docSnap.exists() || !docSnap.data().displayName){
        usernameSection.style.display="flex";
      } else {
        window.location.href="main.html";
      }
    }
    checkUser();
  }
});
</script>
</body>
</html>
